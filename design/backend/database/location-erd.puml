@startuml
!theme mono

title 장소 서비스(Location Service) ERD

' 데이터베이스 스키마 정의
!define TABLE(name,desc) class name as "desc" << (T,#FFAAAA) >>
!define PK(x) <b>x</b>
!define FK(x) <i>x</i>

' 테이블 정의
TABLE(places, "PLACES\n(장소)") {
    PK(id: VARCHAR(50))
    --
    name: VARCHAR(200) NOT NULL
    description: TEXT
    category: VARCHAR(50) NOT NULL
    sub_categories: JSONB
    location: GEOGRAPHY(POINT) NOT NULL
    latitude: DECIMAL(10,8) NOT NULL
    longitude: DECIMAL(11,8) NOT NULL
    address: VARCHAR(500) NOT NULL
    street_address: VARCHAR(300)
    postal_code: VARCHAR(20)
    country: VARCHAR(50) NOT NULL
    region: VARCHAR(100)
    district: VARCHAR(100)
    neighborhood: VARCHAR(100)
    rating: DECIMAL(2,1)
    review_count: INTEGER
    price_level: SMALLINT
    tags: JSONB
    thumbnail_url: VARCHAR(500)
    is_active: BOOLEAN
    data_source: VARCHAR(20) NOT NULL
    external_id: VARCHAR(100)
    created_at: TIMESTAMP NOT NULL
    updated_at: TIMESTAMP NOT NULL
    last_validated: TIMESTAMP
    version: INTEGER
}

TABLE(place_details, "PLACE_DETAILS\n(장소 상세정보)") {
    PK(FK(place_id: VARCHAR(50)))
    --
    phone: VARCHAR(50)
    email: VARCHAR(100)
    social_media: JSONB
    website: VARCHAR(500)
    reservation_url: VARCHAR(500)
    amenities: JSONB
    photos: JSONB
    popular_times: JSONB
    created_at: TIMESTAMP NOT NULL
    updated_at: TIMESTAMP NOT NULL
}

TABLE(business_hours, "BUSINESS_HOURS\n(영업시간)") {
    PK(id: BIGSERIAL)
    --
    FK(place_id: VARCHAR(50)) NOT NULL
    day_of_week: SMALLINT NOT NULL
    open_time: TIME
    close_time: TIME
    break_start: TIME
    break_end: TIME
    is_24_hours: BOOLEAN
    is_closed: BOOLEAN
    created_at: TIMESTAMP NOT NULL
    updated_at: TIMESTAMP NOT NULL
}

TABLE(special_hours, "SPECIAL_HOURS\n(특별 영업시간)") {
    PK(id: BIGSERIAL)
    --
    FK(place_id: VARCHAR(50)) NOT NULL
    date: DATE NOT NULL
    open_time: TIME
    close_time: TIME
    is_closed: BOOLEAN
    reason: VARCHAR(200)
    created_at: TIMESTAMP NOT NULL
}

TABLE(reviews, "REVIEWS\n(리뷰)") {
    PK(id: BIGSERIAL)
    --
    FK(place_id: VARCHAR(50)) NOT NULL
    external_id: VARCHAR(100)
    author: VARCHAR(100) NOT NULL
    rating: DECIMAL(2,1) NOT NULL
    text: TEXT
    language: VARCHAR(10)
    helpful_count: INTEGER
    photos: JSONB
    data_source: VARCHAR(20) NOT NULL
    created_at: TIMESTAMP NOT NULL
    imported_at: TIMESTAMP NOT NULL
}

TABLE(region_info, "REGION_INFO\n(지역 정보)") {
    PK(region_code: VARCHAR(50))
    --
    region_name: VARCHAR(100) NOT NULL
    FK(parent_code: VARCHAR(50))
    characteristics: JSONB
    popular_categories: JSONB
    seasonal_highlights: JSONB
    timezone: VARCHAR(50)
    created_at: TIMESTAMP NOT NULL
    updated_at: TIMESTAMP NOT NULL
}

TABLE(place_search_cache, "PLACE_SEARCH_CACHE\n(장소 검색 캐시)") {
    PK(cache_key: VARCHAR(500))
    --
    search_criteria: JSONB NOT NULL
    result_ids: JSONB NOT NULL
    result_count: INTEGER NOT NULL
    created_at: TIMESTAMP NOT NULL
    expires_at: TIMESTAMP NOT NULL
}

TABLE(translation_cache, "TRANSLATION_CACHE\n(번역 캐시)") {
    PK(id: BIGSERIAL)
    --
    original_text: TEXT NOT NULL
    source_language: VARCHAR(10) NOT NULL
    target_language: VARCHAR(10) NOT NULL
    translated_text: TEXT NOT NULL
    created_at: TIMESTAMP NOT NULL
    expires_at: TIMESTAMP NOT NULL
}

' 관계 정의
places ||--o| place_details : "has"
places ||--o{ business_hours : "has"
places ||--o{ special_hours : "has"
places ||--o{ reviews : "has"
region_info ||--o{ region_info : "parent"

' 인덱스 표시
note right of places
  **Indexes:**
  - GIST: location (공간 인덱스)
  - B-tree: category
  - B-tree: (latitude, longitude)
  - B-tree: (region, district)
  - B-tree: rating DESC
  - B-tree: updated_at DESC
  - GIN: sub_categories
  - GIN: tags
  - Unique: (data_source, external_id)
end note

note right of place_details
  **Indexes:**
  - GIN: amenities
end note

note right of business_hours
  **Indexes:**
  - B-tree: place_id
  - Unique: (place_id, day_of_week)
end note

note right of special_hours
  **Indexes:**
  - B-tree: (place_id, date)
  - Unique: (place_id, date)
end note

note right of reviews
  **Indexes:**
  - B-tree: place_id
  - B-tree: (place_id, rating DESC)
  - B-tree: (place_id, created_at DESC)
  - B-tree: (place_id, language)
  - Unique: (data_source, external_id)
end note

note right of region_info
  **Indexes:**
  - B-tree: parent_code
end note

note right of place_search_cache
  **Indexes:**
  - B-tree: expires_at
end note

note right of translation_cache
  **Indexes:**
  - B-tree: expires_at
  - B-tree: (source_language, target_language)
  - Unique: (original_text, source_language, target_language)
end note

' 범례
note bottom
  **Legend:**
  - PK: Primary Key
  - FK: Foreign Key
  - * : NOT NULL
  - ** : Primary Key field
  
  **PostGIS Types:**
  - GEOGRAPHY(POINT, 4326): 공간 데이터 타입
  
  **JSON Storage:**
  - JSONB: 바이너리 JSON (인덱싱 가능)
end note

@enduml