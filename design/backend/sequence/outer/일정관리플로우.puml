@startuml
!theme mono

title 일정관리플로우 - 외부 시퀀스 다이어그램

participant "User" as U
participant "API Gateway" as GW
participant "Itinerary Service" as IS
participant "Location Service" as LS
participant "Redis Cache" as RC

== 일정 목록 조회 ==
U -> GW: GET /api/itinerary/trips/{tripId}/itineraries\n[특정 여행의 일정 목록 조회]
note right: tripId: 여행 ID
GW -> RC: 캐시 조회 (trip:{tripId}:itineraries)
alt 캐시 미스
    GW -> IS: GET /trips/{tripId}/itineraries\n[일정 목록 조회]
    IS -> RC: 캐시 저장 (TTL: 5분)
end

== 일정 수정 ==
U -> GW: PUT /api/itinerary/trips/{tripId}/itineraries/{itineraryId}\n[일정 정보 수정]
note right: 일정 제목, 날짜, 시간 등 수정\n요청 본문: ItineraryUpdateRequest
GW -> IS: PUT /trips/{tripId}/itineraries/{itineraryId}\n[일정 업데이트]
IS -> RC: 캐시 무효화 (trip:{tripId}:*)

== 장소 추가 ==
U -> GW: POST /api/itinerary/trips/{tripId}/itineraries/{itineraryId}/places\n[일정에 장소 추가]
note right: 요청 본문: PlaceAddRequest\n(placeId, visitTime, duration 등)
GW -> IS: POST /trips/{tripId}/itineraries/{itineraryId}/places\n[장소 추가]
IS -> LS: GET /places/{placeId}\n[장소 상세 정보 조회]
note right: 장소 유효성 검증
IS -> RC: 캐시 무효화 (trip:{tripId}:itinerary:{itineraryId})

== 장소 삭제 ==
U -> GW: DELETE /api/itinerary/places/{placeId}\n[일정에서 장소 삭제]
note right: placeId: 삭제할 장소 ID
GW -> IS: DELETE /places/{placeId}\n[장소 삭제]
IS -> RC: 캐시 무효화 (관련 일정 캐시)

== 경로 계산 ==
U -> GW: POST /api/itinerary/trips/{tripId}/routes/calculate\n[최적 경로 계산]
note right: 요청 본문: RouteCalculateRequest\n(출발지, 경유지 목록, 이동수단 등)
GW -> RC: 캐시 조회 (route:{requestHash})
alt 캐시 미스
    GW -> IS: POST /trips/{tripId}/routes/calculate\n[경로 계산 요청]
    IS -> LS: POST /routes/optimize\n[경로 최적화 요청]
    note right: 다중 장소 간 최적 경로 계산\n외부 지도 API 활용
    IS -> RC: 캐시 저장 (TTL: 30분)
end

note over U,RC
**캐시 전략**
- 일정 목록: TTL 5분
- 경로 계산: TTL 30분 (비용이 큰 작업)
- 수정/삭제 시: 관련 캐시 즉시 무효화
end note

@enduml