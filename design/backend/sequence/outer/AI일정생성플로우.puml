@startuml
!theme mono

title AI일정생성플로우 - 외부 시퀀스 다이어그램

participant "User" as U
participant "API Gateway" as GW
participant "Itinerary Service" as IS
participant "Location Service" as LS
participant "Redis Cache" as RC
participant "Job Queue" as JQ
participant "Claude API" as CA
participant "카카오 MCP" as KM
participant "구글 MCP" as GM

U -> GW: POST /api/itinerary/trips/{tripId}/itineraries (AI 일정 생성 요청)
note right: 여행 ID, 생성 옵션, 추가 요구사항 전달

GW -> IS: AI 일정 생성 요청 전달

IS -> RC: 프로파일 정보 조회 (멤버 선호도, 건강상태 등)
note right: 캐시에서 빠른 조회

IS -> JQ: AI 일정 생성 작업 등록
note right: 비동기 처리를 위한 작업 큐 등록

IS --> GW: 202 Accepted
GW --> U: 202 Accepted 응답
note right
  응답 내용:
  - jobId: 작업 ID
  - status: "PENDING"
  - message: "일정 생성 요청이 접수되었습니다"
end note

== 비동기 AI 일정 생성 프로세스 (20-30초 소요) ==

JQ -> IS: 일정 생성 작업 시작

loop 최대 3회 반복 (검증 성공할 때까지)
    IS -> CA: 프로파일 기반 일정 생성 요청
    note right: 멤버 선호도, 건강상태, 여행 일정 등 고려
    
    CA --> IS: 추천 장소 목록 (텍스트 형식)
    note right: Claude가 생성한 일정 및 장소 목록
    
    IS -> LS: POST /places/validate-batch (Claude 추천 장소 일괄 검증)
    note right: 생성된 모든 장소의 실제 존재 여부 확인
    
    LS -> KM: 각 장소 검증 (병렬 처리)
    KM --> LS: 장소 검증 결과
    
    LS -> GM: 추가 정보 수집 (평점, 리뷰 등)
    GM --> LS: 장소 상세 정보
    
    LS --> IS: 검증 결과 (존재/미존재 목록)
    
    alt 모든 장소 검증 성공
        IS -> IS: 일정 확정
        break
    else 일부 장소 검증 실패
        IS -> IS: 검증 실패 장소 목록 생성
        note right: 다음 시도에서 제외할 장소 정보
    end
end

IS -> RC: 생성된 일정 캐싱 (완료 상태)
note right: 검증 완료된 최종 일정 저장

== 클라이언트 폴링 ==

loop 작업 완료까지 (1-2초 간격)
    U -> GW: GET /api/itinerary/trips/{tripId}/generation-status/{jobId}
    note right: 주기적 상태 확인
    
    GW -> IS: 작업 상태 조회
    
    IS -> RC: Redis 캐시에서 작업 상태 조회
    
    IS --> GW: GenerationStatus (PENDING/PROCESSING/COMPLETED/FAILED)
    GW --> U: 상태 응답
    note right
      응답 내용:
      - jobId, status, progress
      - message (상태 메시지)
      - result (완료 시 itineraryId 포함)
      - error (실패 시 에러 정보)
    end note
end

U -> GW: GET /api/itinerary/trips/{tripId}/itineraries (생성된 일정 조회)
note right: 작업 완료 후 최종 일정 조회

GW -> IS: 일정 목록 조회

IS -> RC: 캐시된 일정 정보 조회

IS --> GW: 검증 완료된 일정 목록
GW --> U: 최종 일정 응답

@enduml