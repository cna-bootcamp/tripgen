graph TB
    %% TripGen 서비스 개발환경 네트워크 다이어그램
    %% Azure 클라우드 기반 마이크로서비스 아키텍처

    %% 외부 영역
    subgraph Internet["🌐 인터넷"]
        Developer["👨‍💻 개발자"]
        QATester["🧪 QA 테스터"]
    end

    %% Azure 클라우드 개발환경
    subgraph AzureCloud["☁️ Azure Cloud - 개발환경"]
        
        %% Virtual Network
        subgraph VNet["🏢 Virtual Network<br/>주소: 10.1.0.0/16"]
            
            %% Public Subnet - 외부 진입점
            subgraph PublicSubnet["🌐 Public Subnet (10.1.1.0/24)"]
                LoadBalancer["⚖️ Azure Load Balancer<br/>Public IP: dev-tripgen.eastasia.cloudapp.azure.com"]
            end

            %% Private Subnet - AKS 클러스터
            subgraph PrivateSubnet["🔒 Private Subnet (10.1.2.0/24)"]
                
                subgraph AKSCluster["⚙️ AKS Cluster"]
                    
                    %% Ingress Controller
                    IngressController["🚪 NGINX Ingress<br/>NodePort: 30080/30443"]
                    
                    %% 마이크로서비스
                    subgraph MicroServices["🚀 마이크로서비스"]
                        UserService["👤 User Service<br/>Replicas: 2<br/>Port: 8080"]
                        TripService["🗺️ Trip Service<br/>Replicas: 2<br/>Port: 8080"]
                        AIService["🤖 AI Service<br/>Replicas: 1<br/>Port: 8080"]
                        LocationService["📍 Location Service<br/>Replicas: 2<br/>Port: 8080"]
                    end
                    
                    %% 데이터 저장소
                    subgraph DataTier["💾 데이터 저장소"]
                        PostgreSQL["🐘 PostgreSQL<br/>Port: 5432<br/>Storage: 100GB"]
                        Redis["🔴 Redis<br/>Port: 6379<br/>Memory: 2GB"]
                    end
                end
            end

            %% Service Bus Subnet
            subgraph MessageSubnet["📨 Message Subnet (10.1.3.0/24)"]
                
                subgraph ServiceBus["📮 Azure Service Bus"]
                    ServiceBusEndpoint["🔗 tripgen-dev-sb.servicebus.windows.net"]
                    
                    subgraph Queues["📬 메시지 큐"]
                        AIQueue["🤖 ai-schedule-generation"]
                        LocationQueue["📍 location-search"]
                        NotificationQueue["🔔 notification"]
                    end
                end
            end
        end

        %% Azure 관리 서비스
        subgraph AzureServices["🛠️ Azure 관리 서비스"]
            LogAnalytics["📊 Log Analytics"]
            AppInsights["📈 Application Insights"]
            KeyVault["🔐 Key Vault<br/>Secrets & Configs"]
            ContainerRegistry["📦 Container Registry"]
        end

        %% 네트워크 보안 그룹
        subgraph SecurityGroups["🔒 Network Security Groups"]
            PublicNSG["🌐 Public NSG<br/>• HTTPS:443 (Allow)<br/>• HTTP:80 (Allow)"]
            PrivateNSG["🔒 Private NSG<br/>• Port:8080 (Internal)<br/>• Port:5432 (DB)<br/>• Port:6379 (Cache)"]
            MessageNSG["📨 Message NSG<br/>• HTTPS:443 (App only)<br/>• AMQP:5671 (App only)"]
        end
    end

    %% 네트워크 트래픽 흐름

    %% 외부 → 내부 트래픽
    Developer -->|"HTTPS:443"| LoadBalancer
    QATester -->|"API 테스트"| LoadBalancer

    %% Load Balancer → Ingress
    LoadBalancer -->|"NodePort"| IngressController

    %% Ingress → 마이크로서비스
    IngressController -->|"/api/users/**"| UserService
    IngressController -->|"/api/trips/**"| TripService
    IngressController -->|"/api/ai/**"| AIService
    IngressController -->|"/api/locations/**"| LocationService

    %% 서비스 간 통신
    UserService <-->|"REST API:8080"| TripService
    TripService <-->|"REST API:8080"| AIService
    AIService <-->|"REST API:8080"| LocationService

    %% 데이터베이스 연결
    UserService -->|"JDBC:5432"| PostgreSQL
    TripService -->|"JDBC:5432"| PostgreSQL
    AIService -->|"JDBC:5432"| PostgreSQL
    LocationService -->|"JDBC:5432"| PostgreSQL

    %% 캐시 연결
    UserService -->|"Redis:6379"| Redis
    TripService -->|"Redis:6379"| Redis
    AIService -->|"Redis:6379"| Redis
    LocationService -->|"Redis:6379"| Redis

    %% 메시징 연결
    AIService -->|"AMQP/HTTPS"| ServiceBusEndpoint
    LocationService -->|"AMQP/HTTPS"| ServiceBusEndpoint
    TripService -->|"AMQP/HTTPS"| ServiceBusEndpoint

    ServiceBusEndpoint --> AIQueue
    ServiceBusEndpoint --> LocationQueue
    ServiceBusEndpoint --> NotificationQueue

    %% 모니터링 & 보안
    MicroServices -->|"Logs & Metrics"| LogAnalytics
    MicroServices -->|"APM"| AppInsights
    MicroServices -->|"Secrets"| KeyVault
    AKSCluster -->|"Image Pull"| ContainerRegistry

    %% NSG 적용
    PublicSubnet -.->|"보안 규칙"| PublicNSG
    PrivateSubnet -.->|"보안 규칙"| PrivateNSG
    MessageSubnet -.->|"보안 규칙"| MessageNSG

    %% 스타일 정의
    classDef azureStyle fill:#0078D4,stroke:#fff,stroke-width:2px,color:#fff
    classDef networkStyle fill:#1E90FF,stroke:#fff,stroke-width:2px,color:#fff
    classDef k8sStyle fill:#326CE5,stroke:#fff,stroke-width:2px,color:#fff
    classDef appStyle fill:#28A745,stroke:#fff,stroke-width:2px,color:#fff
    classDef dataStyle fill:#DC3545,stroke:#fff,stroke-width:2px,color:#fff
    classDef messageStyle fill:#FD7E14,stroke:#fff,stroke-width:2px,color:#fff
    classDef securityStyle fill:#6F42C1,stroke:#fff,stroke-width:2px,color:#fff
    classDef managedStyle fill:#17A2B8,stroke:#fff,stroke-width:2px,color:#fff

    %% 스타일 적용
    class AzureCloud azureStyle
    class VNet,PublicSubnet,PrivateSubnet,MessageSubnet networkStyle
    class AKSCluster,IngressController k8sStyle
    class MicroServices,UserService,TripService,AIService,LocationService appStyle
    class DataTier,PostgreSQL,Redis dataStyle
    class ServiceBus,ServiceBusEndpoint,Queues,AIQueue,LocationQueue,NotificationQueue messageStyle
    class SecurityGroups,PublicNSG,PrivateNSG,MessageNSG,KeyVault securityStyle
    class AzureServices,LogAnalytics,AppInsights,ContainerRegistry managedStyle