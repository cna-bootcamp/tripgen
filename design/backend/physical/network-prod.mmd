graph TB
    %% ìš´ì˜í™˜ê²½ ë„¤íŠ¸ì›Œí¬ ë‹¤ì´ì–´ê·¸ë¨
    %% AI ê¸°ë°˜ ì—¬í–‰ ì¼ì • ìƒì„± ì„œë¹„ìŠ¤ - ìš´ì˜í™˜ê²½

    %% ì™¸ë¶€ ì˜ì—­
    subgraph Internet["ğŸŒ ì¸í„°ë„·"]
        Users["ğŸ‘¥ ì‹¤ì‚¬ìš©ì<br/>(1ë§Œ~10ë§Œ ëª…)"]
        CDN["ğŸŒ Azure Front Door<br/>+ CDN"]
    end

    %% Azure í´ë¼ìš°ë“œ ì˜ì—­
    subgraph AzureCloud["â˜ï¸ Azure Cloud (ìš´ì˜í™˜ê²½)"]
        
        %% Virtual Network
        subgraph VNet["ğŸ¢ Virtual Network (VNet)<br/>ì£¼ì†Œ ê³µê°„: 10.0.0.0/16"]
            
            %% Gateway Subnet
            subgraph GatewaySubnet["ğŸšª Gateway Subnet<br/>10.0.4.0/24"]
                subgraph AppGateway["ğŸ›¡ï¸ Application Gateway + WAF"]
                    PublicIP["ğŸ“ Public IP<br/>(ê³ ì •)"]
                    PrivateIP["ğŸ“ Private IP<br/>(10.0.4.10)"]
                    WAF["ğŸ›¡ï¸ WAF<br/>(OWASP CRS 3.2)"]
                    RateLimiter["â±ï¸ Rate Limiting<br/>(100 req/min/IP)"]
                end
            end
            
            %% Application Subnet
            subgraph AppSubnet["ğŸ¯ Application Subnet<br/>10.0.1.0/24"]
                
                %% AKS í´ëŸ¬ìŠ¤í„°
                subgraph AKSCluster["âš™ï¸ AKS Premium Cluster<br/>(Multi-Zone)"]
                    
                    %% System Node Pool
                    subgraph SystemNodes["ğŸ”§ System Node Pool"]
                        SystemNode1["ğŸ“¦ System Node 1<br/>(Zone 1)"]
                        SystemNode2["ğŸ“¦ System Node 2<br/>(Zone 2)"]
                        SystemNode3["ğŸ“¦ System Node 3<br/>(Zone 3)"]
                    end
                    
                    %% Application Node Pool
                    subgraph AppNodes["ğŸš€ Application Node Pool"]
                        AppNode1["ğŸ“¦ App Node 1<br/>(Zone 1)"]
                        AppNode2["ğŸ“¦ App Node 2<br/>(Zone 2)"]
                        AppNode3["ğŸ“¦ App Node 3<br/>(Zone 3)"]
                    end
                    
                    %% Application Services (High Availability)
                    subgraph AppServices["ğŸš€ Application Services"]
                        UserServiceHA["ğŸ‘¤ User Service<br/>(3 replicas, HPA)"]
                        TripServiceHA["ğŸ—ºï¸ Trip Service<br/>(3 replicas, HPA)"]
                        AIServiceHA["ğŸ¤– AI Service<br/>(2 replicas, HPA)"]
                        LocationServiceHA["ğŸ“ Location Service<br/>(2 replicas, HPA)"]
                    end
                    
                    %% Internal Load Balancer
                    subgraph InternalLB["âš–ï¸ Internal Services"]
                        UserServiceLB["user-service.prod.svc.cluster.local:8080"]
                        TripServiceLB["trip-service.prod.svc.cluster.local:8080"]
                        AIServiceLB["ai-service.prod.svc.cluster.local:8080"]
                        LocationServiceLB["location-service.prod.svc.cluster.local:8080"]
                    end
                end
            end
            
            %% Database Subnet
            subgraph DBSubnet["ğŸ—„ï¸ Database Subnet<br/>10.0.2.0/24"]
                subgraph AzurePostgreSQL["ğŸ˜ Azure PostgreSQL Flexible Server"]
                    PGPrimary["ğŸ“Š Primary Server<br/>(Zone 1)"]
                    PGSecondary["ğŸ“Š Read Replica<br/>(Zone 2)"]
                    PGBackup["ğŸ’¾ Automated Backup<br/>(Point-in-time Recovery)"]
                end
            end
            
            %% Cache Subnet
            subgraph CacheSubnet["âš¡ Cache Subnet<br/>10.0.3.0/24"]
                subgraph AzureRedis["ğŸ”´ Azure Cache for Redis Premium"]
                    RedisPrimary["âš¡ Primary Cache<br/>(Zone 1)"]
                    RedisSecondary["âš¡ Secondary Cache<br/>(Zone 2)"]
                    RedisCluster["ğŸ”— Redis Cluster<br/>(High Availability)"]
                end
            end
        end
        
        %% Service Bus (Premium)
        subgraph ServiceBus["ğŸ“¨ Azure Service Bus Premium"]
            ServiceBusHA["ğŸ“® Service Bus Namespace<br/>(sb-tripgen-prod)"]
            
            subgraph QueuesHA["ğŸ“¬ Premium Message Queues"]
                AIQueueHA["ğŸ¤– ai-schedule-generation<br/>(Partitioned, 16GB)"]
                LocationQueueHA["ğŸ“ location-search<br/>(Partitioned, 16GB)"]
                NotificationQueueHA["ğŸ”” notification<br/>(Partitioned, 16GB)"]
            end
        end
        
        %% Private Endpoints
        subgraph PrivateEndpoints["ğŸ”’ Private Endpoints"]
            PGPrivateEndpoint["ğŸ” PostgreSQL<br/>Private Endpoint"]
            RedisPrivateEndpoint["ğŸ” Redis<br/>Private Endpoint"]
            ServiceBusPrivateEndpoint["ğŸ” Service Bus<br/>Private Endpoint"]
        end
    end

    %% ë„¤íŠ¸ì›Œí¬ ì—°ê²° ê´€ê³„

    %% ì™¸ë¶€ì—ì„œ Azureë¡œì˜ ì ‘ê·¼
    Users -->|"HTTPS ìš”ì²­"| CDN
    CDN -->|"ê¸€ë¡œë²Œ ê°€ì†"| PublicIP

    %% Application Gateway ë‚´ë¶€ íë¦„
    PublicIP --> WAF
    WAF --> RateLimiter
    RateLimiter --> PrivateIP

    %% Application Gatewayì—ì„œ AKSë¡œ
    PrivateIP -->|"/api/users/**<br/>NodePort 30080"| UserServiceLB
    PrivateIP -->|"/api/trips/**<br/>NodePort 30081"| TripServiceLB
    PrivateIP -->|"/api/ai/**<br/>NodePort 30082"| AIServiceLB
    PrivateIP -->|"/api/locations/**<br/>NodePort 30083"| LocationServiceLB

    %% Load Balancerì—ì„œ ì‹¤ì œ ì„œë¹„ìŠ¤ë¡œ
    UserServiceLB -->|"ê³ ê°€ìš©ì„± ë¼ìš°íŒ…"| UserServiceHA
    TripServiceLB -->|"ê³ ê°€ìš©ì„± ë¼ìš°íŒ…"| TripServiceHA
    AIServiceLB -->|"ê³ ê°€ìš©ì„± ë¼ìš°íŒ…"| AIServiceHA
    LocationServiceLB -->|"ê³ ê°€ìš©ì„± ë¼ìš°íŒ…"| LocationServiceHA

    %% ì„œë¹„ìŠ¤ ë°°ì¹˜ (Multi-Zone)
    UserServiceHA -.-> AppNode1
    UserServiceHA -.-> AppNode2
    UserServiceHA -.-> AppNode3
    
    TripServiceHA -.-> AppNode1
    TripServiceHA -.-> AppNode2
    TripServiceHA -.-> AppNode3

    %% Application Servicesì—ì„œ Databaseë¡œ (Private Endpoint)
    UserServiceHA -->|"Private Link<br/>TCP:5432"| PGPrivateEndpoint
    TripServiceHA -->|"Private Link<br/>TCP:5432"| PGPrivateEndpoint
    AIServiceHA -->|"Private Link<br/>TCP:5432"| PGPrivateEndpoint
    LocationServiceHA -->|"Private Link<br/>TCP:5432"| PGPrivateEndpoint

    %% Private Endpointì—ì„œ ì‹¤ì œ ì„œë¹„ìŠ¤ë¡œ
    PGPrivateEndpoint --> PGPrimary
    PGPrivateEndpoint --> PGSecondary

    %% Application Servicesì—ì„œ Cacheë¡œ (Private Endpoint)
    UserServiceHA -->|"Private Link<br/>TCP:6379"| RedisPrivateEndpoint
    TripServiceHA -->|"Private Link<br/>TCP:6379"| RedisPrivateEndpoint
    AIServiceHA -->|"Private Link<br/>TCP:6379"| RedisPrivateEndpoint
    LocationServiceHA -->|"Private Link<br/>TCP:6379"| RedisPrivateEndpoint

    %% Private Endpointì—ì„œ Redisë¡œ
    RedisPrivateEndpoint --> RedisPrimary
    RedisPrivateEndpoint --> RedisSecondary

    %% High Availability ì—°ê²°
    PGPrimary -.->|"ë³µì œ"| PGSecondary
    RedisPrimary -.->|"HA ë™ê¸°í™”"| RedisSecondary
    PGPrimary -.->|"ìë™ ë°±ì—…"| PGBackup

    %% Service Bus ì—°ê²° (Private Endpoint)
    AIServiceHA -->|"Private Link<br/>HTTPS/AMQP"| ServiceBusPrivateEndpoint
    LocationServiceHA -->|"Private Link<br/>HTTPS/AMQP"| ServiceBusPrivateEndpoint
    TripServiceHA -->|"Private Link<br/>HTTPS/AMQP"| ServiceBusPrivateEndpoint

    ServiceBusPrivateEndpoint --> ServiceBusHA
    ServiceBusHA --> AIQueueHA
    ServiceBusHA --> LocationQueueHA
    ServiceBusHA --> NotificationQueueHA

    %% ìŠ¤íƒ€ì¼ ì •ì˜
    classDef azureStyle fill:#0078D4,stroke:#fff,stroke-width:2px,color:#fff
    classDef k8sStyle fill:#326CE5,stroke:#fff,stroke-width:2px,color:#fff
    classDef appStyle fill:#28A745,stroke:#fff,stroke-width:2px,color:#fff
    classDef dbStyle fill:#DC3545,stroke:#fff,stroke-width:2px,color:#fff
    classDef cacheStyle fill:#FF6B35,stroke:#fff,stroke-width:2px,color:#fff
    classDef serviceStyle fill:#6610F2,stroke:#fff,stroke-width:2px,color:#fff
    classDef queueStyle fill:#FD7E14,stroke:#fff,stroke-width:2px,color:#fff
    classDef securityStyle fill:#E83E8C,stroke:#fff,stroke-width:2px,color:#fff
    classDef haStyle fill:#20C997,stroke:#fff,stroke-width:2px,color:#fff

    %% ìŠ¤íƒ€ì¼ ì ìš©
    class AzureCloud,VNet azureStyle
    class AKSCluster,AppSubnet,SystemNodes,AppNodes k8sStyle
    class AppServices,UserServiceHA,TripServiceHA,AIServiceHA,LocationServiceHA appStyle
    class DBSubnet,AzurePostgreSQL,PGPrimary,PGSecondary,PGBackup dbStyle
    class CacheSubnet,AzureRedis,RedisPrimary,RedisSecondary,RedisCluster cacheStyle
    class InternalLB,UserServiceLB,TripServiceLB,AIServiceLB,LocationServiceLB serviceStyle
    class ServiceBus,ServiceBusHA,QueuesHA,AIQueueHA,LocationQueueHA,NotificationQueueHA queueStyle
    class AppGateway,WAF,RateLimiter,PrivateEndpoints,PGPrivateEndpoint,RedisPrivateEndpoint,ServiceBusPrivateEndpoint securityStyle
    class CDN,SystemNode1,SystemNode2,SystemNode3,AppNode1,AppNode2,AppNode3 haStyle