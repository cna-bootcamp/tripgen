---
apiVersion: v1
kind: ConfigMap
metadata:
  name: location-db-config
  namespace: tripgen-dev
data:
  POSTGRES_DB: "tripgen_location_db"
  POSTGRES_USER: "tripgen_location"
  POSTGRES_SCHEMA: "tripgen_location"
  PGDATA: "/var/lib/postgresql/data/pgdata"
---
apiVersion: v1
kind: Secret
metadata:
  name: location-db-secret
  namespace: tripgen-dev
type: Opaque
data:
  # Base64 인코딩된 값 (실제 운영시 변경 필요)
  POSTGRES_PASSWORD: dHJpcGdlbl9sb2NhdGlvbl8xMjM=  # tripgen_location_123
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: location-db-pvc
  namespace: tripgen-dev
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 15Gi  # PostGIS 및 공간 데이터를 위한 추가 공간
  storageClassName: managed
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: location-db-init-sql
  namespace: tripgen-dev
data:
  01-init-database.sql: |
    -- Database and Schema Creation
    CREATE SCHEMA IF NOT EXISTS tripgen_location;
    SET search_path TO tripgen_location;
    
    -- Extensions (PostGIS 이미지에 이미 설치됨)
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "postgis";
    CREATE EXTENSION IF NOT EXISTS "btree_gin";
    
    -- pg_trgm 확장 (텍스트 검색용)
    CREATE EXTENSION IF NOT EXISTS "pg_trgm";
    
  02-create-places-table.sql: |
    -- Set search path
    SET search_path TO tripgen_location;
    
    -- places 테이블 (장소 기본 정보)
    CREATE TABLE places (
        id                  BIGSERIAL PRIMARY KEY,
        place_id            VARCHAR(36) UNIQUE NOT NULL DEFAULT uuid_generate_v4()::text,
        external_id         VARCHAR(100),
        provider            VARCHAR(20) NOT NULL,
        name                VARCHAR(200) NOT NULL,
        name_en             VARCHAR(200),
        category            VARCHAR(50) NOT NULL,
        sub_category        VARCHAR(50),
        address             VARCHAR(500) NOT NULL,
        address_en          VARCHAR(500),
        location            GEOMETRY(POINT, 4326) NOT NULL,  -- WGS84 좌표계
        rating              DECIMAL(2,1),
        rating_count        INTEGER DEFAULT 0,
        price_level         INTEGER,
        phone               VARCHAR(30),
        website             VARCHAR(500),
        status              VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
        is_verified         BOOLEAN NOT NULL DEFAULT FALSE,
        last_updated        TIMESTAMP WITH TIME ZONE,
        created_by          VARCHAR(36),
        updated_by          VARCHAR(36),
        created_at          TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
        updated_at          TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
        
        -- 제약조건
        CONSTRAINT chk_places_provider CHECK (provider IN ('GOOGLE', 'KAKAO', 'MANUAL')),
        CONSTRAINT chk_places_category CHECK (category IN ('RESTAURANT', 'TOURIST_ATTRACTION', 'LODGING', 'SHOPPING', 'ENTERTAINMENT', 'TRANSPORTATION', 'SERVICE', 'OTHER')),
        CONSTRAINT chk_places_rating CHECK (rating IS NULL OR (rating >= 0.0 AND rating <= 5.0)),
        CONSTRAINT chk_places_rating_count CHECK (rating_count >= 0),
        CONSTRAINT chk_places_price_level CHECK (price_level IS NULL OR (price_level >= 0 AND price_level <= 4)),
        CONSTRAINT chk_places_status CHECK (status IN ('ACTIVE', 'INACTIVE', 'CLOSED', 'TEMPORARY_CLOSED')),
        CONSTRAINT chk_places_name_length CHECK (LENGTH(name) >= 1 AND LENGTH(name) <= 200)
    );
    
  03-create-place-details-table.sql: |
    -- Set search path
    SET search_path TO tripgen_location;
    
    -- place_details 테이블 (장소 상세 정보)
    CREATE TABLE place_details (
        id                  BIGSERIAL PRIMARY KEY,
        place_id            VARCHAR(36) NOT NULL,
        business_hours      JSONB,
        photos              JSONB,
        reviews             JSONB,
        amenities           JSONB,
        accessibility       JSONB,
        parking_info        JSONB,
        weather_impact      JSONB,
        visit_duration      INTEGER,
        best_visit_time     VARCHAR(50),
        crowd_level         JSONB,
        special_notes       TEXT,
        last_verified       TIMESTAMP WITH TIME ZONE,
        created_by          VARCHAR(36),
        updated_by          VARCHAR(36),
        created_at          TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
        updated_at          TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
        
        -- 제약조건
        CONSTRAINT chk_place_details_visit_duration CHECK (visit_duration IS NULL OR (visit_duration >= 15 AND visit_duration <= 480)),
        CONSTRAINT chk_place_details_best_visit_time CHECK (best_visit_time IS NULL OR best_visit_time IN ('MORNING', 'AFTERNOON', 'EVENING', 'NIGHT', 'ANYTIME')),
        
        -- 외래키
        CONSTRAINT fk_place_details_place_id FOREIGN KEY (place_id) REFERENCES places(place_id) ON DELETE CASCADE
    );
    
  04-create-place-recommendations-table.sql: |
    -- Set search path
    SET search_path TO tripgen_location;
    
    -- place_recommendations 테이블 (AI 추천 정보 캐시)
    CREATE TABLE place_recommendations (
        id                      BIGSERIAL PRIMARY KEY,  
        recommendation_id       VARCHAR(36) UNIQUE NOT NULL DEFAULT uuid_generate_v4()::text,
        place_id                VARCHAR(36) NOT NULL,
        user_profile_hash       VARCHAR(64) NOT NULL,
        recommendation_reason   TEXT NOT NULL,
        useful_tips            TEXT,
        context_data           JSONB,
        generated_at           TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
        expires_at             TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT (CURRENT_TIMESTAMP + INTERVAL '24 hours'),
        access_count           INTEGER NOT NULL DEFAULT 0,
        last_accessed          TIMESTAMP WITH TIME ZONE,
        created_by             VARCHAR(36),
        updated_by             VARCHAR(36),
        created_at             TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
        updated_at             TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
        
        -- 제약조건
        CONSTRAINT chk_place_recommendations_reason_length CHECK (LENGTH(recommendation_reason) >= 10),
        CONSTRAINT chk_place_recommendations_expires CHECK (expires_at > created_at),
        CONSTRAINT chk_place_recommendations_access_count CHECK (access_count >= 0),
        
        -- 외래키
        CONSTRAINT fk_place_recommendations_place_id FOREIGN KEY (place_id) REFERENCES places(place_id) ON DELETE CASCADE
    );
    
  05-create-indexes.sql: |
    -- Set search path
    SET search_path TO tripgen_location;
    
    -- places 인덱스
    CREATE UNIQUE INDEX idx_places_place_id ON places(place_id);
    CREATE INDEX idx_places_external_id_provider ON places(external_id, provider) WHERE external_id IS NOT NULL;
    CREATE INDEX idx_places_name ON places(name);
    CREATE INDEX idx_places_category ON places(category);
    CREATE INDEX idx_places_status ON places(status);
    CREATE INDEX idx_places_rating ON places(rating) WHERE rating IS NOT NULL;
    CREATE INDEX idx_places_is_verified ON places(is_verified);
    CREATE INDEX idx_places_created_at ON places(created_at);
    CREATE INDEX idx_places_last_updated ON places(last_updated) WHERE last_updated IS NOT NULL;
    
    -- 공간 인덱스 (PostGIS)
    CREATE INDEX idx_places_location_gist ON places USING GIST(location);
    
    -- 텍스트 검색 인덱스
    CREATE INDEX idx_places_name_trgm ON places USING GIN(name gin_trgm_ops);
    CREATE INDEX idx_places_address_trgm ON places USING GIN(address gin_trgm_ops);
    
    -- place_details 인덱스
    CREATE UNIQUE INDEX idx_place_details_place_id ON place_details(place_id);
    CREATE INDEX idx_place_details_visit_duration ON place_details(visit_duration) WHERE visit_duration IS NOT NULL;
    CREATE INDEX idx_place_details_best_visit_time ON place_details(best_visit_time) WHERE best_visit_time IS NOT NULL;
    CREATE INDEX idx_place_details_last_verified ON place_details(last_verified) WHERE last_verified IS NOT NULL;
    CREATE INDEX idx_place_details_business_hours_gin ON place_details USING GIN(business_hours);
    CREATE INDEX idx_place_details_amenities_gin ON place_details USING GIN(amenities);
    
    -- place_recommendations 인덱스
    CREATE UNIQUE INDEX idx_place_recommendations_recommendation_id ON place_recommendations(recommendation_id);
    CREATE INDEX idx_place_recommendations_place_id ON place_recommendations(place_id);
    CREATE INDEX idx_place_recommendations_user_profile_hash ON place_recommendations(user_profile_hash);
    CREATE INDEX idx_place_recommendations_expires_at ON place_recommendations(expires_at);
    CREATE INDEX idx_place_recommendations_active ON place_recommendations(id) WHERE expires_at > CURRENT_TIMESTAMP;
    CREATE INDEX idx_place_recommendations_context_gin ON place_recommendations USING GIN(context_data);
    
    -- 복합 인덱스
    CREATE INDEX idx_places_category_status_rating ON places(category, status, rating DESC) WHERE status = 'ACTIVE';
    CREATE INDEX idx_place_recommendations_place_user ON place_recommendations(place_id, user_profile_hash);
    
  06-create-functions.sql: |
    -- Set search path
    SET search_path TO tripgen_location;
    
    -- 자동 갱신 트리거 함수들
    CREATE OR REPLACE FUNCTION update_places_updated_at()
    RETURNS TRIGGER AS $$
    BEGIN
        NEW.updated_at = CURRENT_TIMESTAMP;
        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    
    CREATE OR REPLACE FUNCTION update_place_details_updated_at()
    RETURNS TRIGGER AS $$
    BEGIN
        NEW.updated_at = CURRENT_TIMESTAMP;
        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    
    CREATE OR REPLACE FUNCTION update_place_recommendations_updated_at()
    RETURNS TRIGGER AS $$
    BEGIN
        NEW.updated_at = CURRENT_TIMESTAMP;
        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    
    -- 장소 정보 검증 함수
    CREATE OR REPLACE FUNCTION validate_place_location()
    RETURNS TRIGGER AS $$
    BEGIN
        -- 좌표 유효성 검사
        IF ST_X(NEW.location) < -180 OR ST_X(NEW.location) > 180 OR
           ST_Y(NEW.location) < -90 OR ST_Y(NEW.location) > 90 THEN
            RAISE EXCEPTION '유효하지 않은 좌표입니다: lat=%, lng=%', ST_Y(NEW.location), ST_X(NEW.location);
        END IF;
        
        -- 한국 내 좌표인지 확인하여 provider 검증
        IF ST_Contains(ST_GeomFromText('POLYGON((124 33, 132 33, 132 39, 124 39, 124 33))', 4326), NEW.location) THEN
            -- 한국 내 좌표면서 GOOGLE provider인 경우 경고
            IF NEW.provider = 'GOOGLE' THEN
                RAISE NOTICE '한국 내 장소는 KAKAO provider 사용을 권장합니다: %', NEW.name;
            END IF;
        END IF;
        
        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    
    -- 장소 검색을 위한 함수
    CREATE OR REPLACE FUNCTION search_places_nearby(
        center_lat DECIMAL,
        center_lng DECIMAL,
        radius_meters INTEGER DEFAULT 1000,
        search_category VARCHAR DEFAULT NULL,
        search_text VARCHAR DEFAULT NULL,
        limit_count INTEGER DEFAULT 20
    )
    RETURNS TABLE(
        place_id VARCHAR,
        name VARCHAR,
        category VARCHAR,
        address VARCHAR,
        distance_meters INTEGER,
        rating DECIMAL,
        rating_count INTEGER
    ) AS $$
    BEGIN
        RETURN QUERY
        SELECT 
            p.place_id,
            p.name,
            p.category,
            p.address,
            ST_Distance(p.location, ST_SetSRID(ST_MakePoint(center_lng, center_lat), 4326))::INTEGER as distance_meters,
            p.rating,
            p.rating_count
        FROM places p
        WHERE p.status = 'ACTIVE'
          AND ST_DWithin(p.location, ST_SetSRID(ST_MakePoint(center_lng, center_lat), 4326), radius_meters * 0.00001)
          AND (search_category IS NULL OR p.category = search_category)
          AND (search_text IS NULL OR (
              p.name ILIKE '%' || search_text || '%' OR 
              p.address ILIKE '%' || search_text || '%'
          ))
        ORDER BY ST_Distance(p.location, ST_SetSRID(ST_MakePoint(center_lng, center_lat), 4326))
        LIMIT limit_count;
    END;
    $$ LANGUAGE plpgsql;
    
    -- 만료된 데이터 정리 함수
    CREATE OR REPLACE FUNCTION cleanup_expired_location_data()
    RETURNS VOID AS $$
    BEGIN
        -- 만료된 추천 정보 삭제 (7일 후)
        DELETE FROM place_recommendations 
        WHERE expires_at < CURRENT_TIMESTAMP - INTERVAL '7 days';
        
        -- 오래된 장소 정보 중 비활성화된 것 정리 (1년 후)
        UPDATE places 
        SET status = 'INACTIVE' 
        WHERE status = 'ACTIVE' 
          AND last_updated < CURRENT_TIMESTAMP - INTERVAL '1 year'
          AND rating_count = 0;
          
        -- 중복 장소 정리 (같은 좌표, 같은 이름)
        WITH duplicate_places AS (
            SELECT place_id, 
                   ROW_NUMBER() OVER (
                       PARTITION BY name, ST_SnapToGrid(location, 0.0001) 
                       ORDER BY rating_count DESC, created_at DESC
                   ) as rn
            FROM places 
            WHERE status = 'ACTIVE'
        )
        UPDATE places 
        SET status = 'INACTIVE' 
        WHERE place_id IN (
            SELECT place_id FROM duplicate_places WHERE rn > 1
        );
    END;
    $$ LANGUAGE plpgsql;
    
  07-create-triggers.sql: |
    -- Set search path
    SET search_path TO tripgen_location;
    
    -- 트리거 생성
    CREATE TRIGGER trg_places_updated_at
        BEFORE UPDATE ON places
        FOR EACH ROW
        EXECUTE FUNCTION update_places_updated_at();
    
    CREATE TRIGGER trg_place_details_updated_at
        BEFORE UPDATE ON place_details
        FOR EACH ROW
        EXECUTE FUNCTION update_place_details_updated_at();
    
    CREATE TRIGGER trg_place_recommendations_updated_at
        BEFORE UPDATE ON place_recommendations
        FOR EACH ROW
        EXECUTE FUNCTION update_place_recommendations_updated_at();
    
    CREATE TRIGGER trg_places_validate_location
        BEFORE INSERT OR UPDATE ON places
        FOR EACH ROW
        EXECUTE FUNCTION validate_place_location();
    
  08-insert-sample-data.sql: |
    -- Set search path
    SET search_path TO tripgen_location;
    
    -- 샘플 장소 데이터 (뮌헨 주요 관광지)
    INSERT INTO places (
        name, name_en, category, address, address_en, location, rating, rating_count, 
        provider, is_verified, created_by, updated_by
    ) VALUES 
    -- 뮌헨 중앙역
    (
        'München Hauptbahnhof', 'Munich Central Station', 'TRANSPORTATION',
        'Bayerstraße 10A, 80335 München, Germany', 'Bayerstraße 10A, 80335 Munich, Germany',
        ST_SetSRID(ST_MakePoint(11.5581, 48.1402), 4326), 4.2, 15847,
        'GOOGLE', TRUE, uuid_generate_v4()::text, uuid_generate_v4()::text
    ),
    -- 마리엔플라츠
    (
        'Marienplatz', 'Marienplatz', 'TOURIST_ATTRACTION',
        'Marienplatz, 80331 München, Germany', 'Marienplatz, 80331 Munich, Germany',
        ST_SetSRID(ST_MakePoint(11.5755, 48.1374), 4326), 4.6, 28392,
        'GOOGLE', TRUE, uuid_generate_v4()::text, uuid_generate_v4()::text
    ),
    -- 뉴슈반슈타인 성
    (
        'Schloss Neuschwanstein', 'Neuschwanstein Castle', 'TOURIST_ATTRACTION',
        'Neuschwansteinstraße 20, 87645 Schwangau, Germany', 'Neuschwansteinstraße 20, 87645 Schwangau, Germany',
        ST_SetSRID(ST_MakePoint(10.7498, 47.5576), 4326), 4.5, 45672,
        'GOOGLE', TRUE, uuid_generate_v4()::text, uuid_generate_v4()::text
    ),
    -- 호프브로이하우스
    (
        'Hofbräuhaus München', 'Hofbrauhaus Munich', 'RESTAURANT',
        'Platzl 9, 80331 München, Germany', 'Platzl 9, 80331 Munich, Germany',
        ST_SetSRID(ST_MakePoint(11.5797, 48.1378), 4326), 4.3, 38291,
        'GOOGLE', TRUE, uuid_generate_v4()::text, uuid_generate_v4()::text
    ),
    -- 영국 정원
    (
        'Englischer Garten', 'English Garden', 'TOURIST_ATTRACTION',
        'München, Germany', 'Munich, Germany',
        ST_SetSRID(ST_MakePoint(11.5820, 48.1642), 4326), 4.7, 22103,
        'GOOGLE', TRUE, uuid_generate_v4()::text, uuid_generate_v4()::text
    );
    
    -- 각 장소에 대한 상세 정보 샘플 데이터
    WITH sample_places AS (
        SELECT place_id FROM places WHERE name = 'Marienplatz'
    )
    INSERT INTO place_details (
        place_id, business_hours, photos, reviews, amenities, 
        visit_duration, best_visit_time, crowd_level, special_notes,
        created_by, updated_by
    ) 
    SELECT 
        sp.place_id,
        '{
            "monday": {"open": "00:00", "close": "23:59"},
            "tuesday": {"open": "00:00", "close": "23:59"},
            "wednesday": {"open": "00:00", "close": "23:59"},
            "thursday": {"open": "00:00", "close": "23:59"},
            "friday": {"open": "00:00", "close": "23:59"},
            "saturday": {"open": "00:00", "close": "23:59"},
            "sunday": {"open": "00:00", "close": "23:59"}
        }'::jsonb,
        '[
            "https://example.com/marienplatz1.jpg",
            "https://example.com/marienplatz2.jpg"
        ]'::jsonb,
        '[
            {
                "author": "TripAdvisor User",
                "rating": 5,
                "text": "뮌헨의 심장부, 꼭 방문해야 할 곳",
                "date": "2024-01-15"
            }
        ]'::jsonb,
        '[
            "공중화장실",
            "스트리트 퍼포먼스",
            "가이드 투어"
        ]'::jsonb,
        90,
        'MORNING',
        '{
            "morning": "medium",
            "afternoon": "high",
            "evening": "medium",
            "night": "low"
        }'::jsonb,
        '글로켄슈필 공연이 매일 11시, 12시, 17시에 있습니다. 주말에는 매우 혼잡하니 평일 오전 방문을 추천합니다.',
        uuid_generate_v4()::text,
        uuid_generate_v4()::text
    FROM sample_places sp;
    
    -- 샘플 AI 추천 데이터
    WITH sample_places AS (
        SELECT place_id FROM places WHERE name = 'Hofbräuhaus München'
    )
    INSERT INTO place_recommendations (
        place_id, user_profile_hash, recommendation_reason, useful_tips, 
        context_data, created_by, updated_by
    ) 
    SELECT 
        sp.place_id,
        'hash_user_profile_001',
        '호프브로이하우스는 1589년에 설립된 전통 맥주집으로, 전통 독일 음식과 맥주를 즐길 수 있는 곣입니다. 여행객이 맛집 탐방을 선호하신다면 꼭 방문해야 할 대표적인 장소입니다.',
        '저녁 7시 이후에는 매우 혼잡하니 오후 시간대에 방문하는 것을 추천합니다. 전통 독일 소시지와 프리체 조합을 꼭 맛보세요. 예약은 받지 않으니 일찍 가셔야 합니다.',
        '{
            "user_preferences": ["맛집탐방", "전통체험"],
            "visit_season": "spring",
            "group_size": 2
        }'::jsonb,
        uuid_generate_v4()::text,
        uuid_generate_v4()::text
    FROM sample_places sp;
    
  99-comments-and-analyze.sql: |
    -- Set search path
    SET search_path TO tripgen_location;
    
    -- 테이블 코멘트
    COMMENT ON TABLE places IS '장소 기본 정보 및 지리정보 관리';
    COMMENT ON TABLE place_details IS '장소 상세 정보 (영업시간, 리뷰, 편의시설 등)';
    COMMENT ON TABLE place_recommendations IS 'AI 추천 정보 캐시 (24시간 TTL)';
    
    -- 컬럼 코멘트
    COMMENT ON COLUMN places.place_id IS '외부 서비스 참조용 비즈니스 키';
    COMMENT ON COLUMN places.location IS 'PostGIS POINT 타입 (WGS84 좌표계)';
    COMMENT ON COLUMN places.provider IS '데이터 제공자 (GOOGLE/KAKAO/MANUAL)';
    COMMENT ON COLUMN place_details.business_hours IS '영업시간 정보 (JSONB)';
    COMMENT ON COLUMN place_details.crowd_level IS '시간대별 혼잡도 정보 (JSONB)';
    COMMENT ON COLUMN place_recommendations.user_profile_hash IS '사용자 프로필 해시 (캐시 키)';
    
    -- PostGIS 버전 확인
    SELECT PostGIS_Version();
    
    -- 성능 통계 수집
    ANALYZE places, place_details, place_recommendations;
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: location-db
  namespace: tripgen-dev
  labels:
    app: location-db
    component: database
    service: location-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: location-db
  template:
    metadata:
      labels:
        app: location-db
        component: database
        service: location-service
    spec:
      containers:
      - name: postgres-postgis
        image: postgis/postgis:14-3.2-alpine  # PostGIS 포함 이미지
        ports:
        - containerPort: 5432
          name: postgres
        env:
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: location-db-secret
              key: POSTGRES_PASSWORD
        envFrom:
        - configMapRef:
            name: location-db-config
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
        - name: init-sql
          mountPath: /docker-entrypoint-initdb.d
        resources:
          requests:
            memory: "768Mi"
            cpu: "500m"
          limits:
            memory: "1.5Gi"
            cpu: "1000m"
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - exec pg_isready -U tripgen_location -d tripgen_location_db -h 127.0.0.1 -p 5432
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 6
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - exec pg_isready -U tripgen_location -d tripgen_location_db -h 127.0.0.1 -p 5432
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 3
      volumes:
      - name: postgres-storage
        persistentVolumeClaim:
          claimName: location-db-pvc
      - name: init-sql
        configMap:
          name: location-db-init-sql
      restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: location-db-service
  namespace: tripgen-dev
  labels:
    app: location-db
    component: database
    service: location-service
spec:
  type: ClusterIP
  ports:
  - port: 5435
    targetPort: 5432
    protocol: TCP
    name: postgres
  selector:
    app: location-db